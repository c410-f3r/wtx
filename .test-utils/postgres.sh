#!/usr/bin/env bash
DATA_DIR="$PGDATA"
echo "-----BEGIN CERTIFICATE-----
MIIDGzCCAgOgAwIBAgIULfMxOCpH518ImycugYA+u89m790wDQYJKoZIhvcNAQEL
BQAwHTELMAkGA1UEBhMCRkkxDjAMBgNVBAMMBXZhaGlkMB4XDTI1MDIyODEzMTE1
MFoXDTMwMDIyNzEzMTE1MFowHTELMAkGA1UEBhMCRkkxDjAMBgNVBAMMBXZhaGlk
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApHGj8QHvYFWmjaIbrn7m
I0OW3PVD0ICsQiTHN2F28MvBCbDG1jpiVMl4guaZYQP1EOkfPs9qqmhPlF2xo6ub
4zn/7SzqnAYect8lZU0528AfmsIKyGXN334jN4e8i6n8kTPGBUnoAsRAvMfHiUHl
LONFmZGvU4yl/NqyKlzUUrWmIPABz8zhsVA6JRJOsXqq5H/FUZYXtjIx7boZbbk4
UYpEt5dnrEIabzTa2o01WwYzVfYLMyOjpqsrAX02AdetCLDjSAabgNISY3pDgcDz
eYeKFMqu0LsEgEUmUN+Jz4E9wixS2Wc7iSVn3NGYqnSIDJwuREkFhyAPAAt3zPZp
pwIDAQABo1MwUTAdBgNVHQ4EFgQUBy1s3M39Wf4s158jKT+KbPZyDhgwHwYDVR0j
BBgwFoAUBy1s3M39Wf4s158jKT+KbPZyDhgwDwYDVR0TAQH/BAUwAwEB/zANBgkq
hkiG9w0BAQsFAAOCAQEAP1beR2/2+A/Ns3JACZNWWnVSh/hOpnVyh84h074K0PgQ
SWxOpIo4h7nJZYbYsX0cOJjFeL26wL/vFwvj51Giv2nv+KRYDUptmRZk12s04H4P
ea2OyJd0uNVIiE1HMhaFKFP7oDJHtxFGOhDmpaK+OtNgiVpCPRj/X5ykWevpIJyu
1yihcC/pb8AnbNutoGGHPRafmRqYKv8o0O6Zo8a4jBbAPczx0isrOA4Rimc4pzj8
rR9/Vp39U96cqMN5VJjq76e+mMvAIFok96e1kxUiAR3MxAHBEJHy67mgXUnpFmo8
OJr01JQiBJh4DTPuk6ixLGX3PpbVkHh4aV0bXxBRkQ==
-----END CERTIFICATE-----" > $DATA_DIR/root-ca.crt
echo "-----BEGIN CERTIFICATE-----
MIIDMTCCAhmgAwIBAgIUPJqPiqkz9u8yhgNp33wtkkagFb0wDQYJKoZIhvcNAQEL
BQAwHTELMAkGA1UEBhMCRkkxDjAMBgNVBAMMBXZhaGlkMB4XDTI1MDIyODEzMTE1
MFoXDTMwMDIyNzEzMTE1MFowHTELMAkGA1UEBhMCRkkxDjAMBgNVBAMMBXZhaGlk
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsnDBjqUrpFVUPekeNFiS
X8NhwALcC2XBvPY5YjzGjh67t3Jf3rkuijWxbPO8CYx/s3CVBSUSsxXqzXQsyF0q
Wf+rgjXjdY4k4dW2ItlKxpl82DxojVpkb+9lR4UJLKVjTTXUIV9cJ0n/BPrqUrRP
n92R8StTos6UNVsQSRePMPq2Xf5zY/dCQm2mgpQTjaCP/mcYAi8OqyVszSexZlzk
4RHUpscKCRf9XwWmycvR4C8D4IZVI0wC7/3asR23JiJSUHCRxIW1m1X3MqKc3gdH
0We08lth/e/tn+R/v0Xg+9Dmvs5ZAAVpuj9OBKwKaiTyO/x2kUy1xVnssBXF8r7E
mQIDAQABo2kwZzAfBgNVHSMEGDAWgBQHLWzczf1Z/izXnyMpP4ps9nIOGDAJBgNV
HRMEAjAAMBoGA1UdEQQTMBGCCWxvY2FsaG9zdIcEfwAAATAdBgNVHQ4EFgQUR1AZ
VIByZgflEamTYP10/hikPJcwDQYJKoZIhvcNAQELBQADggEBAHxXsOYUnVoaOnE4
0zGRz+Yw58wFcPMuYIFnk1Dz3cdhzzi8ruNCOGmR06F6H99gayIQ0CojaUUz7LSY
SiZdKZKwoGntWj6JJoJCT9XkOJvoooly+R+ivDX2HLCQcZkkBBUjCl0jMFMYQ5Fx
oQiXcpE7fu3l052jE9svXykLo4Pd8KFsBiIANrHZ7fcy9lPtkbdl59cwMCjw+Oex
98HkFBiuNRQF1fEfoYMRlxRiejIqm+SZ/rJzcnT09YzBQHbpo4MKOO7doq0/ewjP
ZBdzadAZGs07HQOMuGuap2FiNOgcx5I+jdYIhZNvvxu+11iDjFEBSMcHiVriWvNz
L5Ilu0g=
-----END CERTIFICATE-----" > $DATA_DIR/cert.pem
echo "-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCycMGOpSukVVQ9
6R40WJJfw2HAAtwLZcG89jliPMaOHru3cl/euS6KNbFs87wJjH+zcJUFJRKzFerN
dCzIXSpZ/6uCNeN1jiTh1bYi2UrGmXzYPGiNWmRv72VHhQkspWNNNdQhX1wnSf8E
+upStE+f3ZHxK1OizpQ1WxBJF48w+rZd/nNj90JCbaaClBONoI/+ZxgCLw6rJWzN
J7FmXOThEdSmxwoJF/1fBabJy9HgLwPghlUjTALv/dqxHbcmIlJQcJHEhbWbVfcy
opzeB0fRZ7TyW2H97+2f5H+/ReD70Oa+zlkABWm6P04ErApqJPI7/HaRTLXFWeyw
FcXyvsSZAgMBAAECggEAJ4C/0ODu9uvvAN+1UJhVGz8pSjU32owV5kvKK13SBQ93
tiZrY+ayD2XQmBKjS6ffc22Wh/OLnrrY5s/zxA2f/RmVMffVGaa0sow5zKA3Jh0/
nq1M5hIfTwp77OfePpSElci3ZAX05DvE6ajUrCd/wx/tmariUpYSCHfW9J9zEz/m
8pW/QVOQsz1wsKKqDeRnAqKm0fbn0l2tsJ/3OVf679oVckgpR7ebQZM+R/Q9wSr6
5vMhf7JFsihOnLzdo6ism4DgUJY+hXk4vUtafstW2WJ2Rew002q2BiVPJQi2H276
0TzUA57kWzcQNNPc8y9/VCyUbn/IyC8XYA3u5d/dwwKBgQDWV8wDR4gVHpEy5e6T
+Rk2HJgqKQfVLZdn1ItTJp5ElDcgsMWXmz0t79VWhvxr24H63NxkJ+3NanG3MWL8
LGofXE4PIQ+YNc9VDS3fJRkhj5PcCjcM4C2G0k/TNfPLt30vYe9+oHaG6D/ltWEh
HElq8/RdeCFSZ7jWCDVVBKRJmwKBgQDVHrPHAHGlaSHb2O6/XYELd8BPpsg2ADS1
iZ9BeUEdEdvD5YhFIM+CXgm3zmFe2OUb91IY81N02abEzqMxwE55sEptFgT3KAnI
nJwjC5KfiPCEcWtHKDIV527xtznoKgaNDjLPvkAzBeI7rddZt+4rgfGODkCZ4UeR
AJ/w+SK32wKBgQCUGdgCUBOsHBHRrGQ75DtSU1Gkl/MsjjL2cDrQeneTBSJOOTZe
Ocp9CiFLhzu0vthB4Qd7QMekTq9CGCLAAWRWRO4+r+ZZkpyutMuEStrhgJZ2zKwa
/m8WoAy98KKCmUcrTS0xPmiHcMRt0PTK7wOfne60AsRrbvWdFdDb7LgjjwKBgC9Z
AtfTYWw+TydoqqIZQ/IoSLFpfFGC+jLawGbraWvr68c512yEPZXZDo+najqINV5h
M/wXExOCx2ox/k+vSb//SomxuqiuXH4VTRr8FzcaVVUXXZ4RcA8tu5g3/MV3kL0F
yoQc4GZ1iC16Eb38/wzrcZ79y5xkUGIGoYIH147BAoGAdkCsrcx5yGicIR/WBcN0
UIMwi+MtTfyyZfYLCqHAAHDPl8Qjm4gGtiMhGQG+dOhX9d5rEIwLeVoMe/suV2Oh
6XQvFiWn5A1EwOyyDpTf/6+cK44bKLg9UgPdEmn47R0AE7BOTy9EPaUuWHSOzTI3
GrDDewJI1SYDD5Sj2qQcvUw=
-----END PRIVATE KEY-----" > $DATA_DIR/key.pem
chmod 0600 $PGDATA/key.pem
cat >> "$PGDATA/postgresql.conf" <<-EOF
ssl = on
ssl_ca_file = 'root-ca.crt'
ssl_cert_file = 'cert.pem'
ssl_key_file = 'key.pem'
EOF
cat > "$PGDATA/pg_hba.conf" <<-EOF
host    all wtx_scram   0.0.0.0/0   scram-sha-256
host    all wtx_scram       ::0/0   scram-sha-256
EOF

psql -v ON_ERROR_STOP=1 --username $POSTGRES_USER <<-EOF
    SET password_encryption TO 'scram-sha-256';
    CREATE ROLE wtx_scram PASSWORD 'wtx' LOGIN;
    GRANT ALL ON DATABASE wtx TO wtx_scram;
    ALTER DATABASE wtx OWNER TO wtx_scram;
EOF
